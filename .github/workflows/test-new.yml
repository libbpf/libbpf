name: libbpf-ci-new

on:
  pull_request:

concurrency:
  group: ci-test-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  vmtest:
    strategy:
      fail-fast: false
      matrix:
        arch: ["x86_64"]
        build_runs_on: ["ubuntu-24.04"]
        runs_on: ["ubuntu-24.04"]
        toolchain:
          - {"name": "llvm", "fullname": "llvm-17", "version": 17}
        tests:
          - include:
            - {"test": "test_progs", "continue_on_error": false, "timeout_minutes": 360}
            - {"test": "test_progs_no_alu32", "continue_on_error": false, "timeout_minutes": 360}
            - {"test": "test_verifier", "continue_on_error": false, "timeout_minutes": 360}
        kernel: ['LATEST', '5.5.0', '4.9.0']
    name: Kernel ${{ matrix.kernel }} on ${{ matrix.arch }} + selftests
    uses: libbpf/ci/.github/workflows/kernel-build-test.yml@v1
    with:
      arch: ${{ matrix.arch }}
      build_release: false
      build_runs_on: ${{ toJSON(matrix.build_runs_on) }}
      download_sources: true
      kernel: ${{ matrix.kernel }}
      llvm-version: ${{ matrix.toolchain.version }}
      runs_on: ${{ toJSON(matrix.runs_on) }}
      run_tests: true
      tests: ${{ toJSON(matrix.tests) }}
      toolchain: ${{ matrix.toolchain.name }}
      toolchain_full: ${{ matrix.toolchain.fullname }}

